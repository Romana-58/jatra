// This is your Prisma schema file for Jatra Railway
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  nid           String         @unique @db.VarChar(13) // National ID (10 or 13 digits)
  email         String         @unique @db.VarChar(255)
  phone         String         @unique @db.VarChar(20) // BD format: +880 or 01...
  passwordHash  String         @db.VarChar(255)
  name          String         @db.VarChar(255)
  role          Role           @default(USER)
  emailVerified Boolean        @default(false)
  phoneVerified Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  refreshTokens RefreshToken[]
  bookings      Booking[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(500)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("refresh_tokens")
}

enum Role {
  USER
  ADMIN
}

// Schedule Service Models
model Station {
  id        String   @id @default(uuid())
  code      String   @unique @db.VarChar(10) // e.g., DHK, CTG, SYL
  name      String   @db.VarChar(255)
  city      String   @db.VarChar(100)
  district  String   @db.VarChar(100)
  latitude  Float?
  longitude Float?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  routeStopsFrom   RouteStop[]   @relation("FromStation")
  routeStopsTo     RouteStop[]   @relation("ToStation")
  reservationsFrom Reservation[] @relation("ReservationFrom")
  reservationsTo   Reservation[] @relation("ReservationTo")

  @@index([code])
  @@index([city])
  @@map("stations")
}

model Train {
  id          String    @id @default(uuid())
  trainNumber String    @unique @db.VarChar(20) // e.g., SUBORNO-EXPRESS-701
  name        String    @db.VarChar(255) // e.g., Suborno Express
  type        TrainType @default(INTERCITY)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  coaches  Coach[]
  journeys Journey[]

  @@index([trainNumber])
  @@map("trains")
}

model Coach {
  id         String     @id @default(uuid())
  trainId    String
  train      Train      @relation(fields: [trainId], references: [id], onDelete: Cascade)
  coachCode  String     @db.VarChar(20) // e.g., KA, KHA, GA
  coachType  CoachType
  totalSeats Int
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  seats Seat[]

  @@unique([trainId, coachCode])
  @@index([trainId])
  @@map("coaches")
}

model Seat {
  id           String         @id @default(uuid())
  coachId      String
  coach        Coach          @relation(fields: [coachId], references: [id], onDelete: Cascade)
  seatNumber   String         @db.VarChar(10) // e.g., A1, B2
  seatType     SeatType
  baseFare     Float          @db.DoublePrecision
  bookingSeats BookingsSeat[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@unique([coachId, seatNumber])
  @@index([coachId])
  @@map("seats")
}

model Route {
  id            String   @id @default(uuid())
  routeName     String   @db.VarChar(255) // e.g., "Dhaka-Chittagong"
  totalDistance Float    @db.DoublePrecision // in kilometers
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  stops    RouteStop[]
  journeys Journey[]

  @@map("routes")
}

model RouteStop {
  id                String   @id @default(uuid())
  routeId           String
  route             Route    @relation(fields: [routeId], references: [id], onDelete: Cascade)
  fromStationId     String
  fromStation       Station  @relation("FromStation", fields: [fromStationId], references: [id])
  toStationId       String
  toStation         Station  @relation("ToStation", fields: [toStationId], references: [id])
  stopOrder         Int // Order of this stop in the route
  distanceFromStart Float    @db.DoublePrecision // Distance from first station
  durationMinutes   Int // Estimated travel time from previous stop
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([routeId, stopOrder])
  @@index([routeId])
  @@index([fromStationId])
  @@index([toStationId])
  @@map("route_stops")
}

model Journey {
  id               String        @id @default(uuid())
  trainId          String
  train            Train         @relation(fields: [trainId], references: [id])
  routeId          String
  route            Route         @relation(fields: [routeId], references: [id])
  departureTime    DateTime
  arrivalTime      DateTime
  journeyDate      DateTime      @db.Date
  status           JourneyStatus @default(SCHEDULED)
  availableSeats   Int
  totalSeats       Int
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  reservations     Reservation[]
  bookings         Booking[]

  @@index([trainId])
  @@index([routeId])
  @@index([journeyDate])
  @@index([departureTime])
  @@map("journeys")
}

enum TrainType {
  INTERCITY
  MAIL_EXPRESS
  COMMUTER
  LOCAL
}

enum CoachType {
  AC_BERTH
  AC_SEAT
  AC_CHAIR
  SNIGDHA
  SHOVAN
  SHOVAN_CHAIR
}

enum SeatType {
  BERTH_LOWER
  BERTH_UPPER
  SEAT
  CHAIR
}

enum JourneyStatus {
  SCHEDULED
  DELAYED
  CANCELLED
  COMPLETED
}

// Seat Reservation Service Models
model Reservation {
  id                String            @id @default(uuid())
  userId            String
  journeyId         String
  journey           Journey           @relation(fields: [journeyId], references: [id])
  seatIds           String[]          // Array of seat IDs reserved
  fromStationId     String
  fromStation       Station           @relation("ReservationFrom", fields: [fromStationId], references: [id])
  toStationId       String
  toStation         Station           @relation("ReservationTo", fields: [toStationId], references: [id])
  status            ReservationStatus @default(LOCKED)
  lockExpiry        DateTime
  totalFare         Float             @db.DoublePrecision
  lockId            String            @unique // Redis lock identifier
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  payment           Payment?
  booking           Booking?

  @@index([userId])
  @@index([journeyId])
  @@index([lockId])
  @@index([status])
  @@index([lockExpiry])
  @@map("reservations")
}

enum ReservationStatus {
  LOCKED      // Temporary lock during checkout
  CONFIRMED   // Payment completed
  CANCELLED   // User cancelled
  EXPIRED     // Lock expired without payment
  RELEASED    // Manually released
}

// Payment Service Models
model Payment {
  id                String        @id @default(uuid())
  reservationId     String        @unique
  userId            String
  amount            Float         @db.DoublePrecision
  currency          String        @default("BDT") @db.VarChar(3)
  paymentMethod     PaymentMethod
  status            PaymentStatus @default(PENDING)
  transactionId     String?       @unique @db.VarChar(100)
  gatewayResponse   Json?         // Store full gateway response
  failureReason     String?       @db.VarChar(500)
  paidAt            DateTime?
  refundedAt        DateTime?
  refundAmount      Float?        @db.DoublePrecision
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  reservation       Reservation   @relation(fields: [reservationId], references: [id])
  booking           Booking?

  @@index([userId])
  @@index([reservationId])
  @@index([transactionId])
  @@index([status])
  @@map("payments")
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  MOBILE_BANKING    // bKash, Nagad, Rocket
  NET_BANKING
  WALLET
}

enum PaymentStatus {
  PENDING           // Payment initiated
  PROCESSING        // Payment in progress
  COMPLETED         // Payment successful
  FAILED            // Payment failed
  REFUNDED          // Payment refunded
  PARTIALLY_REFUNDED // Partial refund
  CANCELLED         // Payment cancelled
}

// Booking Service Models
model Booking {
  id              String        @id @default(uuid())
  userId          String
  journeyId       String
  reservationId   String        @unique
  paymentId       String        @unique
  totalAmount     Float         @db.DoublePrecision
  status          BookingStatus @default(DRAFT)
  seats           BookingsSeat[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user            User          @relation(fields: [userId], references: [id])
  journey         Journey       @relation(fields: [journeyId], references: [id])
  reservation     Reservation   @relation(fields: [reservationId], references: [id])
  payment         Payment       @relation(fields: [paymentId], references: [id])

  @@index([userId])
  @@index([journeyId])
  @@index([status])
  @@index([createdAt])
  @@map("bookings")
}

model BookingsSeat {
  id         String   @id @default(uuid())
  bookingId  String
  seatId     String

  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  seat       Seat     @relation(fields: [seatId], references: [id])

  @@unique([bookingId, seatId])
  @@map("bookings_seats")
}

enum BookingStatus {
  DRAFT          // Initial state
  SEATS_LOCKED   // Seats locked, awaiting payment
  PAYMENT_PENDING // Payment initiated
  CONFIRMED      // Payment completed, ticket generated
  CANCELLED      // User cancelled
  FAILED         // Payment or process failed
  EXPIRED        // Timeout during process
}
